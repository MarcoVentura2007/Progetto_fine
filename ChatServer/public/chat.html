<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="immagini/ChatGPT Image 24 mag 2025, 16_00_40.ico">
  <title>Chat - SELENICHAT</title>
  <style>
    body {
      font-family: "bodyfont", sans-serif;
      background-color: #2e2e2e;
      color: #f2f2f2;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 97vh;
    }
  </style>
</head>
<body>
  <video src="video/video_chat.mp4" muted autoplay loop></video>
  <div class="chat_container">
    <div class="chat_header">
      <div class="chat_title" id="chatTitle"></div>
      <button class="butEsci" onclick=extiChat(event)>EXIT</button>
    </div>
    <div class="messages" id="chat"></div>
    <div class="input-container">
        <input type="text" id="messageInput" placeholder="Scrivi un messaggio..." />
        <div class="div_bottone"><button type="submit" class="butInvia" onclick="sendMessage()"><img src="immagini/communication.png" alt=""></button></div>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const username = localStorage.getItem("chatUsername");
    const roomCode = localStorage.getItem('chatRoom');
    document.getElementById('chatTitle').textContent = `SeleniChat: ${roomCode + "üí¨"}`;

    const shownMessages = new Set();

    // Escape di HTML 
    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
    }

    // üîÅ Format del messaggio: escape + sostituzione <br>
    function formatMessage(rawMsg) {
      const safe = escapeHTML(rawMsg);
      return safe.replace(/&lt;br&gt;/g, "<br>"); // consente di mantenere i <br> scritti come testo
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      const timestamp = new Date().toLocaleTimeString();
      const message = `${timestamp}<br>${username}: ${text}`;

      fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `username=${encodeURIComponent(username)}&room=${encodeURIComponent(roomCode)}&message=${encodeURIComponent(message)}`
      });

      input.value = '';
    }

    // Permette l'invio del messaggio con il tasto Invio
    document.getElementById('messageInput').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
          }
    });

    function pollMessages() {
      fetch(`/poll?room=${encodeURIComponent(roomCode)}`)
        .then(response => response.text())
        .then(data => {
          const messages = data.trim().split('\n');

          messages.forEach(msg => {
            if (msg.trim() === '') return;
            
            if (!shownMessages.has(msg)) {
              shownMessages.add(msg);

              const cont_messageU = document.createElement('div');
              cont_messageU.className = 'blocco_messaggi';

              const userMessage = document.createElement('div');
              if (msg.includes(username)) {
                userMessage.className = 'message user';
              } else {
                userMessage.className = 'message other';
              }

              let formatted = formatMessage(msg);
              const match = formatted.match(/<br>([^:]+):/);
              const user = match[1];
              formatted = formatted.replace(`${user}:`, `<span class="username">${user}</span>:`);
              

              userMessage.innerHTML = formatted;
              cont_messageU.appendChild(userMessage);
              chat.appendChild(cont_messageU);

              chat.scrollTop = chat.scrollHeight;
            }
          });
        });
    }

    setInterval(pollMessages, 500);

    function extiChat() {
      window.location.href = 'index.html';
    }
  </script>

</script>

</body>
</html>